{% extends "base.html" %}
{% block title %}Compare Models — {{ symbol }}{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='style/compare.css') }}">

<h2 class="title">Compare Models — {{ symbol }}</h2>

<!-- Toolbar: Models -->
<div class="chart-controls compare-toolbar">
  <a class="btn {{ 'active' if request.args.get('model')=='arima' else '' }}"
     href="{{ url_for('views.forecasting', symbol=symbol, model='arima', steps=request.args.get('steps',steps)) }}">ARIMA</a>
  <a class="btn {{ 'active' if request.args.get('model')=='sarima' else '' }}"
     href="{{ url_for('views.forecasting', symbol=symbol, model='sarima', steps=request.args.get('steps',steps)) }}">SARIMA</a>
  <a class="btn {{ 'active' if request.args.get('model')=='sarimax' else '' }}"
     href="{{ url_for('views.forecasting', symbol=symbol, model='sarimax', steps=request.args.get('steps',steps)) }}">SARIMAX</a>
  <a class="btn {{ 'active' if request.args.get('model')=='lstm' else '' }}"
     href="{{ url_for('views.forecasting', symbol=symbol, model='lstm', steps=request.args.get('steps',steps)) }}">LSTM</a>
</div>

<!-- Dropdown horizon -->
<div class="chart-controls compare-filters">
  <form method="get" action="{{ url_for('views.compare_models', symbol=symbol) }}">
    <select name="steps" id="steps" onchange="this.form.submit()">
      <option value="7"   {{ 'selected' if steps==7 else '' }}>1 Week</option>
      <option value="180" {{ 'selected' if steps==180 else '' }}>6 Months</option>
      <option value="365" {{ 'selected' if steps==365 else '' }}>1 Year</option>
    </select>
  </form>
</div>


<div class="card">
  <p><strong>Last Price:</strong> ${{ last_price }}</p>
  {% if best_model %}
    <p><strong>Best (lowest MAE):</strong> 
      <span class="badge badge-best">{{ best_model }}</span> — ${{ best_mae | round(2) }}
    </p>
  {% endif %}
</div>

<div class="card">
  <table class="table">
    <thead>
      <tr>
        <th>Model</th>
        <th>Backtest MAE ({{ steps }}d)</th>
        <th>Backtest % Error</th>
        <th>{{ steps }}-Day Forecast (last)</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
      {% for m in ['arima','sarima','sarimax','lstm'] %}
        <tr>
          <td>{{ m.upper() }}</td>
          <td>
            {% if results[m].ok %} ${{ results[m].backtest_mae | round(2) }}
            {% else %} - {% endif %}
          </td>
          <td>
            {% if results[m].ok %}
              ~{{ results[m].backtest_mae_pct | round(2) }}%
            {% else %} - {% endif %}
          </td>
          <td>
            {% if results[m].ok %}
              ${{ results[m].forecast_last }}
            {% else %} - {% endif %}
          </td>
          <td>
            {% if results[m].ok %}
              {% if best_model == m.upper() %}
                <span class="badge badge-best">BEST</span>
              {% else %}
                ✓
              {% endif %}
            {% else %}
              <span class="badge badge-warn" title="{{ results[m].error }}">ERR</span>
            {% endif %}
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="card">
  <h3 style="margin:0 0 10px;">Chart</h3>
  <div style="position:relative; width:95%; max-width:1200px;">
    <canvas id="cmpChart"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const ctx = document.getElementById('cmpChart');
  const historical = {{ historical | tojson }};
  const r = {{ results | tojson }};

  const histLabels = historical.map(d => d.date);
  const histPrices = historical.map(d => d.price);
  const baseLen = histPrices.length;

  function pickFutureLabels() {
    for (const k of ['arima','sarima','sarimax','lstm']) {
      if (r[k] && r[k].ok) return r[k].forecast.map(d=>d.date);
    }
    return [];
  }
  const futureLabels = pickFutureLabels();
  const allLabels = histLabels.concat(futureLabels);

  function padForecast(modelKey) {
    if (!r[modelKey] || !r[modelKey].ok) return Array(baseLen).fill(null);
    const vals = r[modelKey].forecast.map(d=>d.price);
    return Array(baseLen).fill(null).concat(vals);
  }

  const arimaF   = padForecast('arima');
  const sarimaF  = padForecast('sarima');
  const sarimaxF = padForecast('sarimax');
  const lstmF    = padForecast('lstm');

  new Chart(ctx, {
    type: 'line',
    data: {
      labels: allLabels,
      datasets: [
        { label: 'Historical', data: histPrices,
          borderColor:'rgb(0,229,255)', borderWidth:2, pointRadius:0, tension:0.1 },
        { label: 'ARIMA Forecast', data: arimaF,
          borderColor:'rgb(255,204,0)', borderDash:[6,6], borderWidth:2, pointRadius:2 },
        { label: 'SARIMA Forecast', data: sarimaF,
          borderColor:'rgb(0,255,132)', borderDash:[6,6], borderWidth:2, pointRadius:2 },
        { label: 'SARIMAX Forecast', data: sarimaxF,
          borderColor:'rgb(153,102,255)', borderDash:[6,6], borderWidth:2, pointRadius:2 },
        { label: 'LSTM Forecast', data: lstmF,
          borderColor:'rgb(255,99,132)', borderDash:[6,6], borderWidth:2, pointRadius:2 },
      ]
    },
    options: {
      scales: {
        y: { beginAtZero:false, grid:{color:'rgba(255,255,255,0.1)'}, ticks:{color:'#fff'} },
        x: { grid:{color:'rgba(255,255,255,0.1)'}, ticks:{color:'#fff'} }
      },
      plugins: { legend:{ labels:{ color:'#fff' } } }
    }
  });
</script>
{% endblock %}
