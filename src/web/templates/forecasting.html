{% extends "base.html" %}
{% block title %}Stock Forecasting{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='style/forecasting.css') }}">

<h2 class="title">Stock Price Forecasting</h2>

{% if symbol %}
  <h3 class="title" style="font-size:28px;">
    <a href="{{ url_for('views.stock_detail', symbol=symbol) }}" style="color:#00e5ff; text-decoration:none;">
        {{ symbol }}
    </a> — {{ model or 'ARIMA' }}
  </h3>

  <div class="model-switch">
    <a class="back-link {{ 'active' if model|lower=='arima' else '' }}" 
       href="{{ url_for('views.forecasting', symbol=symbol, model='arima', steps=request.args.get('steps',steps)) }}">ARIMA</a>
    <a class="back-link {{ 'active' if model|lower=='sarima' else '' }}" 
       href="{{ url_for('views.forecasting', symbol=symbol, model='sarima', steps=request.args.get('steps',steps)) }}">SARIMA</a>
    <a class="back-link {{ 'active' if model|lower=='sarimax' else '' }}" 
       href="{{ url_for('views.forecasting', symbol=symbol, model='sarimax', steps=request.args.get('steps',steps)) }}">SARIMAX</a>
    <a class="back-link {{ 'active' if model|lower=='lstm' else '' }}" 
       href="{{ url_for('views.forecasting', symbol=symbol, model='lstm', steps=request.args.get('steps',steps)) }}">LSTM</a>
    <a class="back-link" 
       href="{{ url_for('views.compare_models', symbol=symbol, steps=request.args.get('steps',steps)) }}">Compare Models</a>
  </div>
{% endif %}

{% if error %}
  <div class="summary-box" style="background:#401818;">
    <p>⚠️ {{ error }}</p>
    <p>Tip: ลองเปลี่ยนโมเดลหรือ horizon โดยกดปุ่มด้านบน</p>
  </div>
{% endif %}

{% if has_data %}
  <div class="cards-container">
      <div class="card">
          <h4>Last Price</h4>
          <p>${{ last_price }}</p>
      </div>
      <div class="card">
          <h4>{{ steps }}-Day Forecast</h4>
          <p>${{ forecast[-1].price }}</p>
      </div>
      <div class="card">
          <h4>MAE</h4>
          <p>{{ backtest_mae | round(2) }}</p>
      </div>
  </div>

  <form method="get" action="">
    <div class="chart-controls forecasting-filters">
      <select name="steps" id="steps" onchange="this.form.submit()">
        <option value="7"   {{ 'selected' if steps==7 else '' }}>1 Week</option>
        <option value="180" {{ 'selected' if steps==180 else '' }}>6 Months</option>
        <option value="365" {{ 'selected' if steps==365 else '' }}>1 Year</option>
      </select>
    </div>
  </form>

  <div class="chart-container" style="position:relative; width:80%; max-width:900px; margin:auto;">
    <canvas id="forecastChart"></canvas>
  </div>

  <p class="disclaimer">This is a statistical forecast, not financial advice.</p>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const ctx = document.getElementById('forecastChart');
    const historicalData = {{ historical | tojson }};
    const forecastData   = {{ forecast   | tojson }};
    const backtestData   = {{ backtest   | tojson }};

    const historicalLabels = historicalData.map(d=>d.date);
    const futureLabels     = forecastData.map(d=>d.date);
    const allLabels        = historicalLabels.concat(futureLabels);

    const historicalPrices = historicalData.map(d=>d.price);
    const backtestPrices   = Array(Math.max(historicalPrices.length - backtestData.length, 0)).fill(null)
                              .concat(backtestData.map(d=>d.price));
    const forecastPrices   = Array(historicalPrices.length).fill(null)
                               .concat(forecastData.map(d=>d.price));

    new Chart(ctx, {
      type: 'line',
      data: {
        labels: allLabels,
        datasets: [
          {
            label: 'Historical Price',
            data: historicalPrices,
            borderColor: 'rgb(0, 229, 255)',
            borderWidth: 2,
            pointRadius: 1,
            tension: 0.1
          },
          {
            label: `Backtest`,
            data: backtestPrices,
            borderColor: 'rgb(0, 255, 132)',
            borderDash:[5,5],
            borderWidth:2,
            pointRadius:2
          },
          {
            label: `Forecast`,
            data: forecastPrices,
            borderColor: 'rgb(255, 204, 0)',
            borderDash:[5,5],
            borderWidth:2,
            pointRadius:2
          }
        ]
      },
      options: {
          scales: {
            y: { 
              beginAtZero: false, 
              grid: { color: 'rgba(255,255,255,0.1)' }, 
              ticks: { color: '#fff' },
              title: {
                display: true,
                text: 'Price (USD)',
                color: '#fff',
                font: { size: 14 }
              }
            },
            x: { 
              grid: { color: 'rgba(255,255,255,0.1)' }, 
              ticks: { color: '#fff' }
            }
          },
          plugins: { legend:{ labels:{ color:'#fff' } } }
        }
    });
  </script>
{% else %}
  {% if symbol %}
    <p class="disclaimer">No data to show for {{ symbol }} — try another model above.</p>
  {% else %}
    <h3 class="title" style="margin-top:50px;">Open from the heatmap to choose a stock.</h3>
  {% endif %}
{% endif %}
{% endblock %}