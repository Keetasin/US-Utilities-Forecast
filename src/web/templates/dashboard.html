<!-- ===== dashboard.html ===== -->
{% extends "base.html" %}
{% block title %}Overview Dashboard{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='style/dashboard.css') }}">

<h1 class="title">US Utilities Sector Dashboard</h1>

<!-- ===== Filter ===== -->
<div class="filter-container">
    <select id="timeFilter">
        <option value="1mo">1 Month</option>
        <option value="6mo">6 Months</option>
        <option value="ytd" selected>YTD</option>
    </select>
</div>

<!-- ===== Charts ===== -->
<div class="chart-section">
    <div id="corrChart" class="chart-box"></div>
    <div id="changeChart" class="chart-box"></div>
</div>

<div class="chart-section hist-section">
    <div id="histChart" class="chart-box hist-long"></div>
</div>

<!-- ===== Stocks Table ===== -->
<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>Ticker</th>
                <th>Market Cap (B)</th>
                <th>Dividend Yield (%)</th>
                <th>P/E Ratio</th>
                <th>Beta (Risk)</th>
                <th>P/B Ratio</th>
                <th>52W High</th>
                <th>52W Low</th>
                <th>YTD Change (%)</th>
                <th>Avg Volume</th>
            </tr>
        </thead>
        <tbody>
            {% for s in stocks %}
            <tr style="background:{{ s.bg_color }}20;">
                <td>{{ s.symbol }}</td>
                <td>{{ "%.2f"|format(s.marketCap / 1e9) }}</td>
                <td>{{ dividend_yields[loop.index0] }}%</td>
                <td>{{ pe_ratios[loop.index0] }}</td>
                <td>{{ betas[loop.index0] }}</td>
                <td>{{ pb_ratios[loop.index0] }}</td>
                <td>{{ high_52w[loop.index0] }}</td>
                <td>{{ low_52w[loop.index0] }}</td>
                <td>{{ ytd_changes[loop.index0] }}%</td>
                <td>{{ avg_volumes[loop.index0] }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
const symbols = {{ symbols|tojson }};
const colors = {{ colors|tojson }};
let historicalPrices = {{ historical_prices|tojson }};
let historicalDates = {{ historical_dates|tojson }};

// ===== Filter Function =====
function filterRange(prices, dates, range) {
    const endDate = new Date(dates[dates.length-1]);
    let startDate;
    switch(range){
        case '1mo': startDate = new Date(endDate); startDate.setMonth(endDate.getMonth()-1); break;
        case '6mo': startDate = new Date(endDate); startDate.setMonth(endDate.getMonth()-6); break;
        case 'ytd': startDate = new Date(endDate); startDate.setMonth(0); startDate.setDate(1); break;
        default: startDate = new Date(dates[0]);
    }
    const filteredDates = [];
    const filteredPrices = prices.map(()=>[]);
    for(let i=0;i<dates.length;i++){
        const d = new Date(dates[i]);
        if(d >= startDate && d <= endDate){
            filteredDates.push(dates[i]);
            for(let j=0;j<prices.length;j++){
                filteredPrices[j].push(prices[j][i]);
            }
        }
    }
    return [filteredPrices, filteredDates];
}

// ===== Compute Change % =====
function computeChange(prices) {
    return prices.map(series => {
        const startVal = series[0];
        const endVal = series[series.length-1];
        return ((endVal - startVal)/startVal*100).toFixed(2);
    });
}

// ===== Draw Charts =====
function drawCharts(range='ytd') {
    const [pricesFiltered, datesFiltered] = filterRange(historicalPrices, historicalDates, range);
    const changes = computeChange(pricesFiltered);

    // Correlation Matrix
    const corrMatrix = [];
    for(let i=0;i<pricesFiltered.length;i++){
        corrMatrix[i] = [];
        for(let j=0;j<pricesFiltered.length;j++){
            const a = pricesFiltered[i];
            const b = pricesFiltered[j];
            const n = a.length;
            const meanA = a.reduce((s,v)=>s+v,0)/n;
            const meanB = b.reduce((s,v)=>s+v,0)/n;
            const cov = a.map((v,k)=> (v-meanA)*(b[k]-meanB)).reduce((s,v)=>s+v,0)/(n-1);
            const stdA = Math.sqrt(a.map(v=>Math.pow(v-meanA,2)).reduce((s,v)=>s+v,0)/(n-1));
            const stdB = Math.sqrt(b.map(v=>Math.pow(v-meanB,2)).reduce((s,v)=>s+v,0)/(n-1));
            corrMatrix[i][j] = (stdA && stdB) ? (cov/(stdA*stdB)) : 0;
        }
    }

    Plotly.newPlot('corrChart',[{
        z: corrMatrix,
        x: symbols,
        y: symbols,
        zmin: -1,
        zmax: 1,
        type: 'heatmap',
        colorscale: 'Viridis',
        text: corrMatrix.map(r => r.map(v => v.toFixed(2))),
        texttemplate: "%{text}",   
        textfont: {color: 'white', size: 12},
    }], {
        title: 'Stock Price Correlation',
        plot_bgcolor: '#111',
        paper_bgcolor: '#111',
        font: {color: '#00e5ff'}
    });


    // Price Change Bar
    const barColors = changes.map(c => c >= 0 ? 'green' : 'red');

    Plotly.newPlot('changeChart',[{
        x: symbols,
        y: changes,
        type: 'bar',
        marker: { color: barColors },
        text: changes.map(d => d+"%"),
        textposition: 'auto'
    }], {
        title: 'Price Change (%)',
        plot_bgcolor: '#111',
        paper_bgcolor: '#111',
        font: {color:'#00e5ff'}
    });


    // Historical Prices Line Chart
    const traces = symbols.map((s,i)=>({
        x:datesFiltered,
        y:pricesFiltered[i],
        type:'scatter',
        mode:'lines',
        name:s
    }));
    Plotly.newPlot('histChart', traces, {
        title:'Historical Prices',
        plot_bgcolor:'#111',
        paper_bgcolor:'#111',
        font:{color:'#00e5ff'},
        width:1200, height:400
    });
}

// Initial draw
drawCharts('ytd');

// Filter event
document.getElementById('timeFilter').addEventListener('change', (e)=>{
    drawCharts(e.target.value);
});
</script>

{% endblock %}
