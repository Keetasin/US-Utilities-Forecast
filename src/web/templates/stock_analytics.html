{% extends "base.html" %}
{% block title %}{{ stock.symbol }} Analytics{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='style/stock_analytics.css') }}">

<h2>{{ stock.symbol }}</h2>
<p>{{ last_updated }}</p>

<!-- ===== Overview Cards ===== -->
<div class="cards-container">
    <div class="card">
        <h4> Dividend Yield</h4>
        <p>{{ overview_data[0].div_yield }}%</p>
    </div>
    <div class="card">
        <h4> P/E Ratio</h4>
        <p>{{ overview_data[0].pe }}</p>
    </div>
    <div class="card">
        <h4> Risk Level (Beta)</h4>
        <p>{{ overview_data[0].beta }}</p>
    </div>
</div>

<!-- ===== Chart Controls ===== -->
<div class="chart-controls">
    <select id="chartSelect">
        <option value="maChart">Price vs Moving Averages (MA50, MA200)</option>
        <option value="relativePerfChart">Relative Performance vs S&P500</option>
        <option value="volatilityChart">Volatility (Rolling Std Dev)</option>
        <option value="revenueChart">Revenue & Net Income Trend</option>
        <option value="dividendChart">Dividend Yield Historical</option>
    </select>

    <select id="timeFilter">
        <option value="1wk">1 Week</option>
        <option value="1mo">1 Month</option>
        <option value="6mo">6 Months</option>
        <option value="1y" selected>1 Year</option>
        <option value="5y">5 Years</option>
    </select>
</div>

<!-- ===== Chart Containers ===== -->
<div class="chart-section">
    <div id="maChart" style="width:100%;height:500px;"></div>
    <div id="relativePerfChart" style="width:100%;height:500px; display:none;"></div>
    <div id="volatilityChart" style="width:100%;height:500px; display:none;"></div>
    <div id="revenueChart" style="width:100%;height:500px; display:none;"></div>
    <div id="dividendChart" style="width:100%;height:500px; display:none;"></div>
</div>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
const chartSelect = document.getElementById('chartSelect');
const timeFilter = document.getElementById('timeFilter');

const hist = {{ hist_prices|tojson }};
const financials = {{ financials|tojson }};
let relativePerf = [];
let volatility = [];
let dividends = hist.Close.map((p,i) => ({Date: hist.Date[i], Value: p * ({{ overview_data[0].div_yield }} / 100)})); // Dividend Yield Historical

// --- Relative Performance ---
(function() {
    const sp500 = {{ sp500_prices|tojson }};
    if(hist.Date.length && sp500.length) {
        relativePerf = hist.Date.map((d,i) => {
            let histPct = hist.Close[i]/hist.Close[0]*100;
            let spPct = sp500[i]/sp500[0]*100;
            return {Date: d, Value: histPct - spPct};
        });
    }
})();

// --- Volatility (Rolling Std Dev 20 วัน) ---
(function() {
    if(hist.Close.length) {
        for(let i=0;i<hist.Close.length;i++){
            if(i<19) volatility.push({Date: hist.Date[i], Value: null});
            else {
                let slice = hist.Close.slice(i-19,i+1);
                let mean = slice.reduce((a,b)=>a+b,0)/20;
                let std = Math.sqrt(slice.reduce((a,b)=>a+Math.pow(b-mean,2),0)/20);
                volatility.push({Date: hist.Date[i], Value: std});
            }
        }
    }
})();

// --- Plot functions ---
function plotMA(timeRange) {
    let startIndex = getStartIndex(hist.Date.length, timeRange);
    const sliced = {
        Date: hist.Date.slice(startIndex),
        Close: hist.Close.slice(startIndex),
        MA50: hist.MA50.slice(startIndex),
        MA200: hist.MA200.slice(startIndex)
    };
    Plotly.newPlot('maChart', [
        { x: sliced.Date, y: sliced.Close, name: 'Price', type: 'scatter', line:{color:'#00e5ff'} },
        { x: sliced.Date, y: sliced.MA50, name: 'MA50', type: 'scatter', line:{color:'#ff6f61'} },
        { x: sliced.Date, y: sliced.MA200, name: 'MA200', type: 'scatter', line:{color:'#ffa500'} }
    ], layoutConfig('Price'));
}

function plotRelative(timeRange) {
    let startIndex = getStartIndex(relativePerf.length, timeRange);
    const sliced = relativePerf.slice(startIndex);
    Plotly.newPlot('relativePerfChart', [
        { x: sliced.map(d=>d.Date), y: sliced.map(d=>d.Value), name: '{{ stock.symbol }} vs S&P500', type:'scatter', line:{color:'#00e5ff'} }
    ], layoutConfig('Relative Performance (%)'));
}

function plotVolatility(timeRange) {
    let startIndex = getStartIndex(volatility.length, timeRange);
    const sliced = volatility.slice(startIndex);
    Plotly.newPlot('volatilityChart', [
        { x: sliced.map(d=>d.Date), y: sliced.map(d=>d.Value), name: 'Volatility', type:'scatter', line:{color:'#ff6f61'} }
    ], layoutConfig('Volatility (Rolling Std Dev)'));
}

function plotRevenue() {
    if(!financials || !financials.length) return;
    const sliced = financials.sort((a,b) => new Date(a.date) - new Date(b.date));
    Plotly.newPlot('revenueChart', [
        { x: sliced.map(d=>d.date), y: sliced.map(d=>d.revenue), name:'Revenue', type:'bar' },
        { x: sliced.map(d=>d.date), y: sliced.map(d=>d.netIncome), name:'Net Income', type:'bar' }
    ], layoutConfig('USD'));
}

// --- Dividend Yield Historical ---
function plotDividend() {
    Plotly.newPlot('dividendChart', [
        { x: dividends.map(d=>d.Date), y: dividends.map(d=>d.Value), name:'Dividend Yield', type:'scatter', line:{color:'#00e5ff'} }
    ], layoutConfig('USD'));
}

// --- Helpers ---
function getStartIndex(length, timeRange) {
    if(timeRange==="1wk") return Math.max(length-7,0);
    if(timeRange==="1mo") return Math.max(length-30,0);
    if(timeRange==="6mo") return Math.max(length-126,0);
    if(timeRange==="1y") return Math.max(length-252,0);
    return 0;
}
function layoutConfig(yTitle){
    return {
        plot_bgcolor:'#111',
        paper_bgcolor:'#111',
        font:{color:'#00e5ff'},
        margin:{ t:50,r:50,l:50,b:50 },
        yaxis:{title:yTitle}
    };
}

// --- Switch charts ---
chartSelect.addEventListener('change', () => {
    const value = chartSelect.value;
    document.getElementById('maChart').style.display = value==='maChart'?'block':'none';
    document.getElementById('relativePerfChart').style.display = value==='relativePerfChart'?'block':'none';
    document.getElementById('volatilityChart').style.display = value==='volatilityChart'?'block':'none';
    document.getElementById('revenueChart').style.display = value==='revenueChart'?'block':'none';
    document.getElementById('dividendChart').style.display = value==='dividendChart'?'block':'none';

    // ซ่อน/แสดง timeFilter
    timeFilter.style.display = (value==='revenueChart' || value==='dividendChart')?'none':'inline-block';

    if(value==='maChart') plotMA(timeFilter.value);
    else if(value==='relativePerfChart') plotRelative(timeFilter.value);
    else if(value==='volatilityChart') plotVolatility(timeFilter.value);
    else if(value==='revenueChart') plotRevenue();
    else if(value==='dividendChart') plotDividend();
});

// --- Update charts on time filter change ---
timeFilter.addEventListener('change', () => {
    if(chartSelect.value==='maChart') plotMA(timeFilter.value);
    else if(chartSelect.value==='relativePerfChart') plotRelative(timeFilter.value);
    else if(chartSelect.value==='volatilityChart') plotVolatility(timeFilter.value);
});

// --- initial plot ---
plotMA(timeFilter.value);
</script>
{% endblock %}
