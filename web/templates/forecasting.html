{% extends "base.html" %}
{% block title %}Stock Forecasting{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='style/heatmap.css') }}">
<style>
.summary-box { display:inline-block; padding:15px 25px; margin-bottom:20px; border-radius:16px; background:rgba(20,20,20,0.8); box-shadow:0 0 15px rgba(0,255,255,0.4); font-size:16px; font-weight:600; }
.summary-box p { margin:5px 0; }
.disclaimer { margin-top:20px; font-size:12px; color:#888; }
.model-switch { margin: 10px 0 25px; }
.model-switch a { margin-right: 10px; padding:8px 12px; border-radius:10px; background:#0e1b22; color:#cfefff; text-decoration:none; border:1px solid #0ff3; }
.model-switch a.active { background:#00e5ff22; border-color:#00e5ff; }
</style>

<h2 class="title">Stock Price Forecasting</h2>

{% if symbol %}
  <h3 class="title" style="font-size:28px;">{{ symbol }} ‚Äî {{ model or 'ARIMA' }}</h3>

  <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏°‡πÄ‡∏î‡∏• ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö -->
  <div class="model-switch">
    <a href="{{ url_for('views.forecasting', symbol=symbol, model='arima') }}" class="{{ 'active' if model=='ARIMA' else '' }}">ARIMA</a>
    <a href="{{ url_for('views.forecasting', symbol=symbol, model='sarima') }}" class="{{ 'active' if model=='SARIMA' else '' }}">SARIMA</a>
    <a href="{{ url_for('views.forecasting', symbol=symbol, model='lstm') }}" class="{{ 'active' if model=='LSTM' else '' }}">LSTM</a>
    <a href="{{ url_for('views.compare_models', symbol=symbol) }}" style="margin-left:10px;">üîÄ Compare 3 Models</a>
  </div>
{% endif %}

{% if error %}
  <div class="summary-box" style="background:#401818;">
    <p>‚ö†Ô∏è {{ error }}</p>
    <p>Tip: ‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÇ‡∏î‡∏¢‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô</p>
  </div>
{% endif %}

{% if has_data %}
    <div class="summary-box">
    <p>Last Price: ${{ last_price }}</p>
    <p>7-Day Forecast: ${{ forecast[-1].price }}</p>
    <p>Trend: {{ trend.icon }} {{ trend.direction }}</p>
    <hr style="border-color:#444;">
    <p>
        Backtest Error (MAE):
        ${{ backtest_mae | round(2) }}
        (~{{ backtest_mae_pct | round(2) }}%)
    </p>
    </div>


  <div class="chart-container" style="position:relative; width:80%; max-width:900px; margin:auto;">
    <canvas id="forecastChart"></canvas>
  </div>

  <p class="disclaimer">This is a statistical forecast, not financial advice.</p>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const ctx = document.getElementById('forecastChart');
    const historicalData = {{ historical | tojson }};
    const forecastData   = {{ forecast   | tojson }};
    const backtestData   = {{ backtest   | tojson }};

    const historicalLabels = historicalData.map(d=>d.date);
    const futureLabels     = forecastData.map(d=>d.date);
    const allLabels        = historicalLabels.concat(futureLabels);

    const historicalPrices = historicalData.map(d=>d.price);
    const backtestPrices   = Array(Math.max(historicalPrices.length - backtestData.length, 0)).fill(null)
                              .concat(backtestData.map(d=>d.price));
    const forecastPrices   = Array(historicalPrices.length).fill(null)
                              .concat(forecastData.map(d=>d.price));

    new Chart(ctx, {
      type: 'line',
      data: {
        labels: allLabels,
        datasets: [
          {
            label: 'Historical Price',
            data: historicalPrices,
            borderColor: 'rgb(0, 229, 255)',
            borderWidth: 2,
            pointRadius: 1,
            tension: 0.1
          },
          {
            label: 'Backtest (last 7)',
            data: backtestPrices,
            borderColor: 'rgb(0, 255, 132)',
            borderDash:[5,5],
            borderWidth:2,
            pointRadius:2
          },
          {
            label: 'Future Forecast (next 7)',
            data: forecastPrices,
            borderColor: 'rgb(255, 204, 0)',
            borderDash:[5,5],
            borderWidth:2,
            pointRadius:2
          }
        ]
      },
      options: {
        scales: {
          y: { beginAtZero:false, grid:{color:'rgba(255,255,255,0.1)'}, ticks:{color:'#fff'} },
          x: { grid:{color:'rgba(255,255,255,0.1)'}, ticks:{color:'#fff'} }
        },
        plugins: { legend:{ labels:{ color:'#fff' } } }
      }
    });
  </script>
{% else %}
  {% if symbol %}
    <p class="disclaimer">No data to show for {{ symbol }} ‚Äî try another model above.</p>
  {% else %}
    <h3 class="title" style="margin-top:50px;">Open from the heatmap to choose a stock.</h3>
  {% endif %}
{% endif %}
{% endblock %}