{% extends "base.html" %}
{% block title %}Stock Forecasting{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='style/forecasting.css') }}">

<h2 class="title">Stock Price Forecasting</h2>

{% if symbol %}
  <h3 class="title" style="font-size:28px;">{{ symbol }} ‚Äî {{ model or 'ARIMA' }}</h3>

  <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏°‡πÄ‡∏î‡∏• -->
  <div class="model-switch">
    <a class="back-link {{ 'active' if model|lower=='arima' else '' }}" 
       href="{{ url_for('views.forecasting', symbol=symbol, model='arima', steps=request.args.get('steps',steps)) }}">ARIMA</a>
    <a class="back-link {{ 'active' if model|lower=='sarima' else '' }}" 
       href="{{ url_for('views.forecasting', symbol=symbol, model='sarima', steps=request.args.get('steps',steps)) }}">SARIMA</a>
    <a class="back-link {{ 'active' if model|lower=='sarimax' else '' }}" 
       href="{{ url_for('views.forecasting', symbol=symbol, model='sarimax', steps=request.args.get('steps',steps)) }}">SARIMAX</a>
    <a class="back-link {{ 'active' if model|lower=='lstm' else '' }}" 
       href="{{ url_for('views.forecasting', symbol=symbol, model='lstm', steps=request.args.get('steps',steps)) }}">LSTM</a>
    <a class="back-link" 
       href="{{ url_for('views.compare_models', symbol=symbol, steps=request.args.get('steps',steps)) }}">üîÄ Compare Models</a>
  </div>

  <!-- Dropdown horizon -->
  <form method="get" action="">
    <label for="steps">Predict horizon:</label>
    <select name="steps" id="steps" onchange="this.form.submit()">
      <option value="7"   {{ 'selected' if steps==7 else '' }}>1 Week</option>
      <option value="90"  {{ 'selected' if steps==90 else '' }}>3 Months</option>
      <option value="365" {{ 'selected' if steps==365 else '' }}>1 Year</option>
    </select>
  </form>
{% endif %}


{% if error %}
  <div class="summary-box" style="background:#401818;">
    <p>‚ö†Ô∏è {{ error }}</p>
    <p>Tip: ‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏´‡∏£‡∏∑‡∏≠ horizon ‡πÇ‡∏î‡∏¢‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô</p>
  </div>
{% endif %}

{% if has_data %}
  <div class="summary-box">
    <p>Last Price: ${{ last_price }}</p>
    <p>{{ steps }}-Day Forecast: ${{ forecast[-1].price }}</p>
    <p>Trend: {{ trend.icon }} {{ trend.direction }}</p>
    <hr style="border-color:#444;">
    <p>
        Backtest Error (MAE):
        ${{ backtest_mae | round(2) }}
        (~{{ backtest_mae_pct | round(2) }}%)
    </p>
  </div>

  <div class="chart-container" style="position:relative; width:80%; max-width:900px; margin:auto;">
    <canvas id="forecastChart"></canvas>
  </div>

  <p class="disclaimer">This is a statistical forecast, not financial advice.</p>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const ctx = document.getElementById('forecastChart');
    const historicalData = {{ historical | tojson }};
    const forecastData   = {{ forecast   | tojson }};
    const backtestData   = {{ backtest   | tojson }};

    const historicalLabels = historicalData.map(d=>d.date);
    const futureLabels     = forecastData.map(d=>d.date);
    const allLabels        = historicalLabels.concat(futureLabels);

    const historicalPrices = historicalData.map(d=>d.price);
    const backtestPrices   = Array(Math.max(historicalPrices.length - backtestData.length, 0)).fill(null)
                              .concat(backtestData.map(d=>d.price));
    const forecastPrices   = Array(historicalPrices.length).fill(null)
                              .concat(forecastData.map(d=>d.price));

    new Chart(ctx, {
      type: 'line',
      data: {
        labels: allLabels,
        datasets: [
          {
            label: 'Historical Price',
            data: historicalPrices,
            borderColor: 'rgb(0, 229, 255)',
            borderWidth: 2,
            pointRadius: 1,
            tension: 0.1
          },
          {
            label: `Backtest (last {{ steps }})`,
            data: backtestPrices,
            borderColor: 'rgb(0, 255, 132)',
            borderDash:[5,5],
            borderWidth:2,
            pointRadius:2
          },
          {
            label: `Future Forecast (next {{ steps }})`,
            data: forecastPrices,
            borderColor: 'rgb(255, 204, 0)',
            borderDash:[5,5],
            borderWidth:2,
            pointRadius:2
          }
        ]
      },
      options: {
        scales: {
          y: { beginAtZero:false, grid:{color:'rgba(255,255,255,0.1)'}, ticks:{color:'#fff'} },
          x: { grid:{color:'rgba(255,255,255,0.1)'}, ticks:{color:'#fff'} }
        },
        plugins: { legend:{ labels:{ color:'#fff' } } }
      }
    });
  </script>
{% else %}
  {% if symbol %}
    <p class="disclaimer">No data to show for {{ symbol }} ‚Äî try another model above.</p>
  {% else %}
    <h3 class="title" style="margin-top:50px;">Open from the heatmap to choose a stock.</h3>
  {% endif %}
{% endif %}
{% endblock %}
